<ion-header mode="ios" class="nav-shell">
  <ion-toolbar class="navbar">
    <ion-buttons class="nav-links" slot="start">
      <ion-button routerLink="/home" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }" fill="clear">
        <img src="assets/logo-edumali.png" class="nav-home-img" alt="Accueil" slot="start" />
        <ion-label>Accueil</ion-label>
      </ion-button>
      <ion-button routerLink="/students" routerLinkActive="active" fill="clear">
        <ion-icon class="nav-icon students" name="people-outline" slot="start"></ion-icon>
        <ion-label>Élèves</ion-label>
      </ion-button>
      <ion-button routerLink="/teachers" routerLinkActive="active" fill="clear">
        <ion-icon class="nav-icon teachers" name="school-outline" slot="start"></ion-icon>
        <ion-label>Enseignants</ion-label>
      </ion-button>
      <ion-button routerLink="/classes" routerLinkActive="active" fill="clear">
        <ion-icon class="nav-icon classes" name="layers-outline" slot="start"></ion-icon>
        <ion-label>Classes & Matières</ion-label>
      </ion-button>
      <ion-button routerLink="/emplois-du-temps" routerLinkActive="active" fill="clear">
        <ion-icon class="nav-icon timetable" name="calendar-outline" slot="start"></ion-icon>
        <ion-label>Emploi du temps</ion-label>
      </ion-button>
      <ion-button routerLink="/evaluations" routerLinkActive="active" fill="clear">
        <ion-icon class="nav-icon evaluations" name="clipboard-outline" slot="start"></ion-icon>
        <ion-label>Évaluations</ion-label>
      </ion-button>
      <ion-button routerLink="/stats" routerLinkActive="active" fill="clear">
        <ion-icon class="nav-icon stats" name="bar-chart-outline" slot="start"></ion-icon>
        <ion-label>Statistiques</ion-label>
      </ion-button>
      @if (currentUser()?.role === 'admin') {
        <ion-button routerLink="/settings" routerLinkActive="active" fill="clear">
          <ion-icon class="nav-icon settings" name="settings-outline" slot="start"></ion-icon>
          <ion-label>Administration</ion-label>
        </ion-button>
      }
    </ion-buttons>

    <ion-buttons slot="end" class="user-actions">
      <!-- Bouton changer thème -->
      <ion-button id="theme-menu-trigger" class="theme-btn" [class]="'theme-' + themeService.currentTheme()" fill="clear" (click)="openThemeMenu($event)" title="Changer le thème">
        <ion-icon name="moon-outline" class="theme-icon"></ion-icon>
      </ion-button>

      @if (currentUser()) {
        <ion-button class="profile-trigger" fill="clear" (click)="openProfileMenu($event)">
          <ion-label class="username">{{ currentUser()?.username }}</ion-label>
          <img 
            [src]="avatar" 
            alt="Profil" 
            class="profile-img" 
            (error)="onImageError($event)"
            loading="lazy"
          />
        </ion-button>
      }
      @else {
        <ion-button class="login-text" fill="clear" routerLink="/login">Connexion</ion-button>
      }
      <ion-button id="main-menu-trigger" class="mobile-menu" fill="clear" color="light">
        <ion-icon name="menu-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- Popover menu (mobile) -->
<ion-popover trigger="main-menu-trigger" triggerAction="click">
  <ng-template>
    <ion-content>
      <ion-list lines="full">
        <ion-item routerLink="/home">
          <ion-icon class="nav-icon home" slot="start" name="home-outline"></ion-icon>
          <ion-label>Accueil</ion-label>
        </ion-item>
        <ion-item routerLink="/students">
          <ion-icon class="nav-icon students" slot="start" name="people-outline"></ion-icon>
          <ion-label>Élèves</ion-label>
        </ion-item>
        <ion-item routerLink="/teachers">
          <ion-icon class="nav-icon teachers" slot="start" name="school-outline"></ion-icon>
          <ion-label>Enseignants</ion-label>
        </ion-item>
        <ion-item routerLink="/classes">
          <ion-icon class="nav-icon classes" slot="start" name="layers-outline"></ion-icon>
          <ion-label>Classes & Matières</ion-label>
        </ion-item>
        <ion-item routerLink="/timetable">
          <ion-icon class="nav-icon timetable" slot="start" name="calendar-outline"></ion-icon>
          <ion-label>Emploi du temps</ion-label>
        </ion-item>
        <ion-item routerLink="/evaluations">
          <ion-icon class="nav-icon evaluations" slot="start" name="clipboard-outline"></ion-icon>
          <ion-label>Évaluations</ion-label>
        </ion-item>
        <ion-item routerLink="/stats">
          <ion-icon class="nav-icon stats" slot="start" name="bar-chart-outline"></ion-icon>
          <ion-label>Statistiques</ion-label>
        </ion-item>
        @if (currentUser()?.role === 'admin') {
          <ion-item routerLink="/settings">
            <ion-icon class="nav-icon settings" slot="start" name="settings-outline"></ion-icon>
            <ion-label>Administration</ion-label>
          </ion-item>
        }
      </ion-list>
    </ion-content>
  </ng-template>
</ion-popover>

<!-- Popover profil (clic) -->
<ion-popover
  [isOpen]="profileMenuOpen()"
  [event]="profilePopoverEvent"
  (didDismiss)="closeProfileMenu()"
  side="bottom"
  alignment="end"
  dismissOnSelect="true"
>
  <ng-template>
    <ion-content>
      <ion-list lines="none">
        <ion-item routerLink="/profile">
          <ion-icon slot="start" name="person-circle-outline"></ion-icon>
          <ion-label>Mon profil</ion-label>
        </ion-item>
        @if (currentUser()?.role === 'admin') {
          <ion-item routerLink="/settings">
            <ion-icon slot="start" name="settings-outline"></ion-icon>
            <ion-label>Paramètres</ion-label>
          </ion-item>
        }
        <ion-item (click)="logout()">
          <ion-icon slot="start" name="log-out-outline"></ion-icon>
          <ion-label>Déconnexion</ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-popover>

<!-- Popover thème (clic) -->
<ion-popover
  [isOpen]="themeMenuOpen()"
  [event]="themePopoverEvent"
  (didDismiss)="closeThemeMenu()"
  side="bottom"
  alignment="end"
  dismissOnSelect="true"
>
  <ng-template>
    <ion-content>
      <ion-list lines="none">
        @for (theme of themeService.availableThemes; track theme.name) {
          <ion-item button (click)="selectTheme(theme.name)" [class.active]="themeService.currentTheme() === theme.name">
            <ion-label>{{ theme.label }}</ion-label>
            @if (themeService.currentTheme() === theme.name) {
              <ion-icon slot="end" name="checkmark-outline"></ion-icon>
            }
          </ion-item>
        }
      </ion-list>
    </ion-content>
  </ng-template>
</ion-popover>
