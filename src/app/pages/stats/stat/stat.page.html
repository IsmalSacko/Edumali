<ion-content class="stat-page">
  <div class="container" *ngIf="dataReady">

    <section class="top-row">
      <div class="title">
        <h1>Statistiques</h1>
        <p class="subtitle">Vue d'ensemble — données factices</p>
        <div class="period-indicator">Période active : <strong>{{ periodLabel }}</strong></div>
      </div>
      <div class="controls">
        <ion-segment [value]="period" (ionChange)="onPeriodChange($event)">
          <ion-segment-button value="all">Tous</ion-segment-button>
          <ion-segment-button value="month">Mois</ion-segment-button>
          <ion-segment-button value="quarter">Trimestre</ion-segment-button>
          <ion-segment-button value="year">Année</ion-segment-button>
        </ion-segment>

      </div>
    </section>

    <section class="kpi-grid">
      <ion-card class="kpi-card">
        <div class="kpi-left">
          <ion-icon name="people" class="kpi-icon"></ion-icon>
          <div>
            <div class="kpi-value">{{ stats?.totalStudents ?? 0 }}</div>
            <div class="kpi-label">Élèves <span class="kpi-note">(total global)</span></div>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-trend positive">{{ stats ? '+4.2%' : '—' }}</div>
        </div>
      </ion-card>

      <ion-card class="kpi-card">
        <div class="kpi-left">
          <ion-icon name="school" class="kpi-icon"></ion-icon>
          <div>
            <div class="kpi-value">{{ stats?.totalClasses ?? 0 }}</div>
            <div class="kpi-label">Classes <span class="kpi-note">(total global)</span></div>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-trend neutral">—</div>
        </div>
      </ion-card>

      <ion-card class="kpi-card">
        <div class="kpi-left">
          <ion-icon name="people" class="kpi-icon"></ion-icon>
          <div>
            <div class="kpi-value">{{ stats?.totalTeachers ?? 0 }}</div>
            <div class="kpi-label">Enseignants <span class="kpi-note">(total global)</span></div>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-trend negative">{{ stats ? '-1.1%' : '—' }}</div>
        </div>
      </ion-card>

      <ion-card class="kpi-card">
        <div class="kpi-left">
          <ion-icon name="clipboard" class="kpi-icon"></ion-icon>
          <div>
            <div class="kpi-value">{{ evalsTotal }}</div>
            <div class="kpi-label">Évaluations</div>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-trend positive">{{ stats ? '+8.6%' : '—' }}</div>
        </div>
      </ion-card>
      <ion-card class="kpi-card">
        <div class="kpi-left">
          <ion-icon slot="start" [icon]="starOutline" class="kpi-icon"></ion-icon>
          <div>
            <div class="kpi-value">{{ mystat.moyenne_generale }}</div>
            <div class="kpi-label">Évaluations</div>
          </div>
        </div>
        <div class="kpi-right">
          <div class="kpi-trend positive">{{ stats ? '+8.6%' : '—' }}</div>
        </div>
      </ion-card>
    </section>

    <section class="charts-grid">

      <!-- ÉVALUATIONS -->
      <ion-card class="chart-card chart-large">
        <ion-card-header>
          <ion-card-title>Évaluations (trimestres)</ion-card-title>
        </ion-card-header>

        <ion-card-content class="canvas-content">
          <div class="canvas-frame">
            <canvasjs-chart *ngIf="chartVisible" [options]="evals" class="canvasjs-evals">
            </canvasjs-chart>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- RÉPARTITION ÉLÈVES -->
      <ion-card class="chart-card compact">
        <ion-card-header>
          <ion-card-title>Répartition élèves</ion-card-title>
        </ion-card-header>

        <ion-card-content class="donut-content">
          <div class="donut-wrap">

            <div class="donut-svg">
              <svg viewBox="0 0 240 160" class="circular-chart">
                <g *ngIf="pieSegments.length">
                  <ng-container *ngFor="let seg of pieSegments">
                    <path [attr.d]="seg.d" [attr.fill]="seg.color"></path>
                  </ng-container>
                </g>

                <g *ngIf="!pieSegments.length">
                  <circle cx="120" cy="80" r="64" fill="#eee"></circle>
                </g>
              </svg>
            </div>

            <div class="donut-legend">
              <div class="item" *ngFor="let seg of pieSegments">
                <span class="dot" [ngStyle]="{ background: seg.color }"></span>
                {{ seg.label }}
                <strong>{{ seg.percent | number:'1.0-0' }}%</strong>
              </div>
            </div>

          </div>
        </ion-card-content>
      </ion-card>

    </section>


    <section class="list-section">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Prochains rendez-vous</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ul class="event-list">
            <li><span class="event-title">Réunion parents</span><span class="event-date">15 janv.</span></li>
            <li><span class="event-title">Examen final</span><span class="event-date">02 févr.</span></li>
            <li><span class="event-title">Formation enseignants</span><span class="event-date">20 févr.</span></li>
          </ul>
        </ion-card-content>
      </ion-card>
    </section>

  </div>

</ion-content>